<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Chat ðŸš€</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Set font and ensure full-height view */
        body { font-family: 'Inter', sans-serif; }
        /* Scrollbar styling for a cleaner look */
        #messages::-webkit-scrollbar { width: 6px; }
        #messages::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 3px; }
        #messages::-webkit-scrollbar-track { background-color: #f3f4f6; }
        .ban-icon, .delete-icon { transition: opacity 0.2s; }
        .message-item:hover .admin-actions { opacity: 1; }
        .admin-actions { opacity: 0; transition: opacity 0.2s; }
        
        /* Mobile Sidebar Transition & Positioning */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed; 
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 20;
                /* Start off-screen */
                transform: translateX(-100%); 
                transition: transform 0.3s ease-in-out;
            }
            /* Open state */
            #sidebar.open {
                transform: translateX(0);
            }
            /* Ensure the chat area is visible when the sidebar is closed */
            .md\:w-1\/3 { width: 100%; }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Custom Modal Structure (Hidden by default) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300 scale-95 opacity-0" id="modal-content-wrapper">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600"></h3>
            <p id="modal-body" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Main Chat Container -->
    <div id="chat-container" class="bg-white rounded-2xl shadow-xl w-full max-w-5xl h-[90vh] flex flex-col md:flex-row overflow-hidden">

        <!-- Sidebar for Auth and Admin Controls -->
        <div id="sidebar" class="md:w-1/3 w-full bg-gray-50 p-6 border-r border-gray-200 flex flex-col transition-all duration-300">
            <h2 class="text-2xl font-extrabold text-blue-600 mb-4 flex items-center">
                <i data-lucide="message-square-text" class="w-6 h-6 mr-2"></i> Super Chat
            </h2>
            
            <!-- Auth Panel -->
            <div id="auth-panel" class="mb-6 pb-4 border-b border-gray-200">
                <p id="user-display" class="text-gray-700 font-semibold mb-3">Sign in or register to chat.</p>
                <div id="auth-inputs">
                    <input type="email" id="email-input" placeholder="Email" class="w-full p-2 mb-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="password" id="password-input" placeholder="Password" class="w-full p-2 mb-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="display-name-input" placeholder="Display Name (Registration)" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    
                    <div class="flex space-x-2">
                        <button id="sign-in-button" class="flex-1 bg-blue-600 text-white p-2 rounded-lg font-medium hover:bg-blue-700 transition">Sign In</button>
                        <button id="register-button" class="flex-1 bg-green-600 text-white p-2 rounded-lg font-medium hover:bg-green-700 transition">Register</button>
                    </div>
                </div>
                
                <button id="sign-out-button" class="hidden w-full bg-red-500 text-white p-2 mt-3 rounded-lg font-medium hover:bg-red-600 transition">Sign Out</button>
                <div id="auth-error" class="text-red-500 text-sm mt-2"></div>
            </div>

            <!-- Admin Controls (Conditional Visibility) -->
            <div id="admin-controls" class="hidden mb-6 pb-4 border-b border-gray-200">
                <h3 class="font-bold text-gray-800 mb-2">Admin Panel</h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <button id="lock-chat-button" class="admin-button bg-yellow-400 text-gray-800 p-2 rounded-lg hover:bg-yellow-500 transition"></button>
                    <button id="disable-chat-button" class="admin-button bg-orange-500 text-white p-2 rounded-lg hover:bg-orange-600 transition"></button>
                    <button id="ban-user-button" class="admin-button bg-purple-500 text-white p-2 rounded-lg hover:bg-purple-600 transition col-span-2"></button>
                    <button id="ban-management-button" class="admin-button bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition col-span-2"></button>
                </div>
                <div id="admin-status" class="text-xs mt-2 text-gray-600 font-medium"></div>
            </div>

            <!-- Banned User Management Panel -->
            <div id="management-panel" class="hidden flex-col flex-grow overflow-y-auto">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                    <i data-lucide="gavel" class="w-5 h-5 mr-1"></i> Ban Management
                </h3>
                <ul id="management-list" class="space-y-2"></ul>
                <button id="back-to-chat-btn" class="w-full mt-4 p-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition font-medium">Back to Chat</button>
            </div>

            <!-- Active User List (Functional) -->
            <div id="user-list" class="mt-auto pt-4 border-t border-gray-200">
                <h3 class="font-bold text-gray-800 mb-2 flex items-center">
                    <i data-lucide="users" class="w-5 h-5 mr-1"></i> Active Users (<span id="active-user-count">0</span>)
                </h3>
                <ul id="active-users-list" class="text-sm space-y-1 text-gray-600 overflow-y-auto max-h-32">
                    <li class="text-gray-400">Sign in to load active users...</li>
                </ul>
            </div>
            
            <!-- Mobile Toggle Button (Hidden on desktop) -->
            <button id="sidebar-toggle" class="md:hidden fixed top-4 right-4 z-30 p-3 bg-blue-600 text-white rounded-full shadow-lg">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Main Chat Area -->
        <div id="chat-main" class="md:w-2/3 w-full flex flex-col relative">
            <header class="p-4 bg-white border-b border-gray-200 flex justify-between items-center sticky top-0 z-10 md:hidden">
                <h2 class="text-lg font-bold text-blue-600">Chat</h2>
            </header>

            <ul id="messages" class="flex-grow overflow-y-auto p-4 space-y-3">
                <!-- Messages will be injected here -->
            </ul>

            <!-- Message Input Form -->
            <form id="message-form" class="hidden p-4 border-t border-gray-200 bg-white">
                <div class="flex space-x-3">
                    <input type="text" id="message-input" placeholder="Type your message here..." class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500" required>
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-xl font-medium hover:bg-blue-700 transition flex items-center justify-center">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
            </form>
            
            <!-- Chat Disabled Overlay -->
             <div id="chat-overlay" class="absolute inset-0 bg-gray-50 bg-opacity-90 flex items-center justify-center hidden">
                <p id="overlay-text" class="text-xl font-semibold text-red-600 p-8 rounded-lg shadow-lg bg-white/90">
                    Chat is currently disabled or locked.
                </p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onChildRemoved, onValue, set, remove, get, serverTimestamp, update } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
        
        // --- 1. CONFIGURATION & INITIALIZATION ---
        
        const firebaseConfig = {
            apiKey: "AIzaSyBSgqIz2e8ClflpJV6X5xFKp6dB_nf-7os",
            authDomain: "chatnow-3ed74.firebaseapp.com",
            databaseURL: "https://chatnow-3ed74-default-rtdb.firebaseio.com",
            projectId: "chatnow-3ed74",
            storageBucket: "chatnow-3ed74.firebasestorage.app",
            messagingSenderId: "327266570463",
            appId: "1:327266570463:web:f80dfbafc563b2b731196a",
            measurementId: "G-THVV1JE47T"
        };
        // Hardcoded list of Admin UIDs (used for client-side UI visibility)
        const ADMIN_UIDS = ["5iVnNfREQzZ7kA9NxWJlLTG5zq53"]; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Database References
        const messagesRef = ref(db, 'messages');
        const configRef = ref(db, 'adminConfig/config');
        const bannedRef = ref(db, 'adminConfig/bannedUsers');
        const activeUsersRef = ref(db, 'activeUsers');
        
        // State Variables
        let isAdmin = false;
        let currentUser = null;
        let isBanMode = false;
        let isChatLocked = false;
        let isChatDisabled = false;
        let isManagementView = false;
        
        // --- 2. UI ELEMENTS & HELPERS ---
        
        const ui = {
            chatContainer: document.getElementById('chat-container'),
            sidebar: document.getElementById('sidebar'),
            chatOverlay: document.getElementById('chat-overlay'),
            overlayText: document.getElementById('overlay-text'),
            
            emailInput: document.getElementById('email-input'),
            passwordInput: document.getElementById('password-input'),
            displayNameInput: document.getElementById('display-name-input'),
            messageForm: document.getElementById('message-form'),
            messageInput: document.getElementById('message-input'),
            authError: document.getElementById('auth-error'),
            
            signInButton: document.getElementById('sign-in-button'),
            registerButton: document.getElementById('register-button'),
            signOutButton: document.getElementById('sign-out-button'),
            lockChatButton: document.getElementById('lock-chat-button'),
            disableChatButton: document.getElementById('disable-chat-button'),
            banUserButton: document.getElementById('ban-user-button'),
            banManagementButton: document.getElementById('ban-management-button'),
            backToChatBtn: document.getElementById('back-to-chat-btn'),
            sidebarToggle: document.getElementById('sidebar-toggle'),

            userDisplay: document.getElementById('user-display'),
            adminControls: document.getElementById('admin-controls'),
            managementPanel: document.getElementById('management-panel'),
            adminStatus: document.getElementById('admin-status'),
            messagesList: document.getElementById('messages'),
            managementList: document.getElementById('management-list'),
            activeUsersList: document.getElementById('active-users-list'),
            activeUserCount: document.getElementById('active-user-count'),
        };

        // Custom Modal Logic (Replaces alert/confirm)
        let modalResolve;
        const modalEl = document.getElementById('custom-modal');
        const modalWrapper = document.getElementById('modal-content-wrapper');

        const showCustomModal = (title, body, confirmAction) => {
            return new Promise((resolve) => {
                modalResolve = resolve;
                ui.chatContainer.classList.add('pointer-events-none', 'filter', 'blur-sm'); 
                modalEl.classList.remove('hidden');
                modalWrapper.classList.remove('scale-95', 'opacity-0');
                modalWrapper.classList.add('scale-100', 'opacity-100');
                
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').textContent = body;
                
                const confirmBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');
                
                confirmBtn.textContent = confirmAction || 'Confirm';
                confirmBtn.onclick = () => { closeModal(true); };
                cancelBtn.onclick = () => { closeModal(false); };
            });
        };

        const closeModal = (result) => {
            modalWrapper.classList.remove('scale-100', 'opacity-100');
            modalWrapper.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modalEl.classList.add('hidden');
                ui.chatContainer.classList.remove('pointer-events-none', 'filter', 'blur-sm');
                if (modalResolve) {
                    modalResolve(result);
                }
            }, 300); 
        };

        const formatTime = (timestamp) => {
            const now = Date.now();
            const diff = now - timestamp; 
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (seconds < 60) return `${seconds}s ago`;
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            
            const date = new Date(timestamp);
            return date.toLocaleDateString();
        };
        
        const displayError = (message) => { ui.authError.textContent = message; };

        // Toggle sidebar for mobile view (using CSS classes for transition)
        let isSidebarOpen = window.innerWidth >= 768; // Start open on desktop, closed on mobile
        
        const toggleSidebar = () => {
            isSidebarOpen = !isSidebarOpen;
            if (isSidebarOpen) {
                ui.sidebar.classList.add('open');
                ui.sidebarToggle.innerHTML = '<i data-lucide="x" class="w-6 h-6"></i>';
            } else {
                ui.sidebar.classList.remove('open');
                ui.sidebarToggle.innerHTML = '<i data-lucide="menu" class="w-6 h-6"></i>';
            }
            lucide.createIcons();
        };
        
        // Initial mobile setup - apply classes based on starting state
        if (window.innerWidth < 768) {
            ui.sidebar.classList.remove('hidden'); 
            ui.sidebarToggle.classList.remove('hidden');
        } else {
            ui.sidebar.classList.add('open'); 
        }
        ui.sidebarToggle.addEventListener('click', toggleSidebar);
        
        // --- 3. AUTHENTICATION & PRESENCE ---

        ui.registerButton.addEventListener('click', async () => {
            const email = ui.emailInput.value;
            const password = ui.passwordInput.value;
            const displayName = ui.displayNameInput.value;
            displayError('');

            if (!email || !password || !displayName) {
                displayError("Email, password, and display name are required for registration.");
                return;
            }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: displayName });
            } catch (error) {
                displayError(`Registration Failed: ${error.message}`);
            }
        });

        ui.signInButton.addEventListener('click', async () => {
            const email = ui.emailInput.value;
            const password = ui.passwordInput.value;
            displayError('');

            if (!email || !password) {
                displayError("Email and password are required for sign in.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                displayError(`Sign In Failed: ${error.message}`);
            }
        });

        ui.signOutButton.addEventListener('click', () => {
            // Manually remove presence marker before signing out
            if(currentUser) {
                 remove(ref(db, 'activeUsers/' + currentUser.uid)).catch(e => console.error("Error removing presence on sign out:", e));
            }
            signOut(auth).catch((error) => console.error("Sign Out Error:", error));
        });
        
        // Setup user presence tracking
        const setupPresence = (user) => {
            if (!user) return;
            const userStatusRef = ref(db, 'activeUsers/' + user.uid);
            const userName = user.displayName || user.email.split('@')[0];
            
            // When connection closes, delete this user's presence node
            userStatusRef.onDisconnect().remove();
            
            // Set user status to online
            set(userStatusRef, { 
                name: userName, 
                lastSeen: serverTimestamp() 
            });
        };

        // Main Auth State Listener
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            displayError('');
            
            // Reset UI state
            ui.messageForm.classList.add('hidden');
            ui.adminControls.classList.add('hidden');
            ui.managementPanel.classList.add('hidden');
            ui.chatOverlay.classList.add('hidden');

            if (user) {
                isAdmin = ADMIN_UIDS.includes(user.uid); 
                const userName = user.displayName || user.email.split('@')[0]; 
                ui.userDisplay.textContent = `Hello, ${userName} ${isAdmin ? '(Admin)' : ''}.`;

                document.getElementById('auth-inputs').classList.add('hidden');
                ui.signOutButton.classList.remove('hidden');

                if (isAdmin) {
                    ui.adminControls.classList.remove('hidden');
                }
                
                setupPresence(user);
                checkChatStateAndBanStatus();

            } else {
                ui.userDisplay.textContent = "Sign in or register to chat.";
                document.getElementById('auth-inputs').classList.remove('hidden');
                ui.signOutButton.classList.add('hidden');
                isAdmin = false;
            }
        });
        
        // --- 4. CHAT STATE & BAN LOGIC ---

        const checkChatStateAndBanStatus = () => {
            if (!currentUser) return;

            // Listener 1: Check Ban Status
            onValue(ref(db, `adminConfig/bannedUsers/${currentUser.uid}`), (snapshot) => {
                const isBanned = snapshot.val() === true;
                
                if (isBanned) {
                    ui.userDisplay.textContent = `â›” You have been banned from this chat.`;
                    showChatOverlay("â›” You have been permanently banned from the chat.");
                    ui.messageForm.classList.add('hidden');
                    // Stop further config checks if banned
                    onValue(configRef, () => {}, { onlyOnce: true }); 
                } else {
                    // Listener 2: Check Admin Config (Locked/Disabled) only if not banned
                    onValue(configRef, (configSnapshot) => {
                        const config = configSnapshot.val() || {};
                        // Ensure null values are treated as false/default
                        isChatLocked = !!config.locked; 
                        isChatDisabled = !!config.disabled;
                        
                        updateChatUI();
                    }, { onlyOnce: false });
                }
            }, { onlyOnce: false });
        };
        
        const updateChatUI = () => {
            // 1. Admin updates
            if (isAdmin) {
                ui.lockChatButton.textContent = isChatLocked ? 'Unlock Chat' : 'Lock Chat';
                ui.disableChatButton.textContent = isChatDisabled ? 'Enable Chat' : 'Disable Chat';
                let statusText = `Locked: ${isChatLocked ? 'Yes' : 'No'} | Disabled: ${isChatDisabled ? 'Yes' : 'No'} | Ban Mode: ${isBanMode ? 'Active' : 'Off'}`;
                ui.adminStatus.textContent = statusText;
                
                // Admins always see chat content and input unless in management view
                if (!isManagementView) {
                    ui.chatOverlay.classList.add('hidden');
                    ui.messageForm.classList.remove('hidden');
                }
                return;
            }

            // 2. Regular user access
            ui.messageForm.classList.remove('hidden');
            ui.chatOverlay.classList.add('hidden');
            
            if (isChatDisabled) {
                showChatOverlay("Chat is currently DISABLED by an administrator.");
                ui.messageForm.classList.add('hidden');
            } else if (isChatLocked) {
                showChatOverlay("Chat is currently LOCKED by an administrator (read-only).");
                ui.messageForm.classList.add('hidden');
            }
        }
        
        const showChatOverlay = (text) => {
            ui.chatOverlay.classList.remove('hidden');
            ui.overlayText.textContent = text;
        }

        // --- 5. ADMIN ACTIONS ---
        
        const toggleBanMode = () => {
            if (!isAdmin) return;
            isBanMode = !isBanMode;
            ui.banUserButton.textContent = isBanMode ? 'Exit Ban Mode' : 'Ban By Message';
            ui.banUserButton.classList.toggle('bg-red-600', isBanMode);
            ui.banUserButton.classList.toggle('hover:bg-red-700', isBanMode);
            ui.banUserButton.classList.toggle('bg-purple-500', !isBanMode);
            ui.banUserButton.classList.toggle('hover:bg-purple-600', !isBanMode);

            // Toggle visibility of ban icons on all messages
            document.querySelectorAll('.admin-actions').forEach(actions => {
                actions.classList.toggle('opacity-100', isBanMode);
            });
            updateChatUI(); 
        };

        const banUser = async (uidToBan, userName) => {
            const confirmed = await showCustomModal(
                'Confirm Ban',
                `Are you sure you want to permanently ban ${userName} (UID: ${uidToBan}) from the chat?`,
                'Confirm Ban'
            );
            
            if (confirmed) {
                set(ref(db, `adminConfig/bannedUsers/${uidToBan}`), true)
                    .then(() => {
                        remove(ref(db, 'activeUsers/' + uidToBan)).catch(e => console.error("Error removing presence:", e)); 
                        showCustomModal('Success', `${userName} has been banned.`, 'OK');
                        if (isBanMode) toggleBanMode(); 
                    })
                    .catch(error => showCustomModal('Error', `Ban Error: ${error.message}`, 'Close'));
            }
        };
        
        const deleteMessage = async (messageId) => {
             const confirmed = await showCustomModal(
                'Confirm Deletion',
                'Are you sure you want to delete this message? This action cannot be undone.',
                'Delete'
            );
            
            if (confirmed) {
                remove(ref(db, `messages/${messageId}`))
                    .catch(error => showCustomModal('Error', `Deletion Error: ${error.message}`, 'Close'));
            }
        }
        
        // Listener for ban/delete actions on the message list
        ui.messagesList.addEventListener('click', (e) => {
            if (!isAdmin || isManagementView) return;

            const icon = e.target.closest('.admin-action-icon');
            if (!icon) return;

            if (icon.classList.contains('ban-icon') && isBanMode) {
                const uidToBan = icon.dataset.uid;
                const userName = icon.dataset.name;
                banUser(uidToBan, userName);
            } else if (icon.classList.contains('delete-icon')) {
                const messageId = icon.dataset.messageId;
                deleteMessage(messageId);
            }
        });
        
        // Toggle Chat Lock/Disable
        ui.lockChatButton.addEventListener('click', () => {
            if (isAdmin) { update(configRef, { locked: !isChatLocked }); }
        });

        ui.disableChatButton.addEventListener('click', () => {
             if (isAdmin) { update(configRef, { disabled: !isChatDisabled }); }
        });

        ui.banUserButton.addEventListener('click', () => {
             if (isManagementView) toggleManagementView(); 
             toggleBanMode();
        });

        // --- 6. BAN MANAGEMENT VIEW ---

        const toggleManagementView = () => {
            isManagementView = !isManagementView;
            
            if (isManagementView) {
                ui.managementPanel.classList.remove('hidden');
                ui.messageForm.classList.add('hidden');
                ui.messagesList.classList.add('hidden');
                ui.chatOverlay.classList.add('hidden');
                ui.adminControls.classList.add('hidden');
                loadBannedUsers();
            } else {
                ui.managementPanel.classList.add('hidden');
                ui.messagesList.classList.remove('hidden');
                ui.adminControls.classList.remove('hidden');
                updateChatUI(); 
            }
            if (isBanMode) toggleBanMode(); 
        };
        
        ui.banManagementButton.addEventListener('click', toggleManagementView);
        ui.backToChatBtn.addEventListener('click', toggleManagementView);

        const loadBannedUsers = async () => {
            ui.managementList.innerHTML = '<li class="text-gray-500">Loading banned users...</li>';

            try {
                const snapshot = await get(bannedRef);
                const bannedUsers = snapshot.val();
                ui.managementList.innerHTML = '';

                if (!bannedUsers || Object.keys(bannedUsers).length === 0) {
                    ui.managementList.innerHTML = '<li class="text-gray-500 p-3 bg-white rounded-lg border">No users are currently banned.</li>';
                    return;
                }
                
                Object.keys(bannedUsers).forEach(uid => {
                    if (bannedUsers[uid] === true) {
                        const li = document.createElement('li');
                        li.className = 'bg-white p-3 rounded-lg shadow-sm border border-red-200 flex justify-between items-center';
                        li.innerHTML = `
                            <span class="text-sm">
                                <strong>UID:</strong> ${uid} <br>
                                <span class="text-red-600 font-medium">Status: BANNED</span> 
                            </span>
                            <button class="unban-btn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition text-sm" data-uid="${uid}">
                                <i data-lucide="unlock" class="w-4 h-4 inline-block mr-1"></i> Unban
                            </button>
                        `;
                        ui.managementList.appendChild(li);
                    }
                });
                lucide.createIcons();
            } catch (error) {
                 ui.managementList.innerHTML = `<li class="text-red-500 p-3">Error loading banned users: ${error.message}</li>`;
            }
        };

        // Ban Management List Click Listener (for Unban)
        ui.managementList.addEventListener('click', async (e) => {
            if (!isAdmin || !e.target.closest('.unban-btn')) return;

            const btn = e.target.closest('.unban-btn');
            const uidToUnban = btn.dataset.uid;
            
            const confirmed = await showCustomModal(
                'Confirm Unban',
                `Are you sure you want to unban UID: ${uidToUnban}?`,
                'Confirm Unban'
            );

            if (confirmed) {
                 remove(ref(db, `adminConfig/bannedUsers/${uidToUnban}`))
                    .then(() => {
                        showCustomModal('Success', `User ${uidToUnban} unbanned.`, 'OK');
                        loadBannedUsers(); 
                    })
                    .catch(error => showCustomModal('Error', `Unban Error: ${error.message}`, 'Close'));
            }
        });
        
        // --- 7. MESSAGE SENDING/RECEIVING ---

        ui.messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentUser || isChatDisabled || (isChatLocked && !isAdmin)) {
                showCustomModal('Access Denied', 'You cannot send messages right now.', 'Close');
                return;
            }
            
            const message = ui.messageInput.value.trim();
            const userName = currentUser.displayName || currentUser.email.split('@')[0];

            if (message) {
                push(messagesRef, {
                    uid: currentUser.uid,
                    name: userName,
                    text: message,
                    timestamp: Date.now()
                });
                ui.messageInput.value = '';
            }
        });

        // Message ADDITION
        onChildAdded(messagesRef, (snapshot) => {
            const data = snapshot.val();
            const messageId = snapshot.key;
            const isSenderAdmin = ADMIN_UIDS.includes(data.uid);

            if (document.getElementById(`message-${messageId}`)) return; 
            
            const li = document.createElement('li');
            li.id = `message-${messageId}`;
            li.className = `message-item flex justify-between items-start p-3 rounded-xl shadow-md transition-all duration-300 ${
                isSenderAdmin 
                    ? 'bg-red-100 border-l-4 border-red-500 text-gray-800' 
                    : 'bg-white border-l-4 border-blue-100 text-gray-800'
            }`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex flex-col min-w-0';

            // Sender and Time
            const header = document.createElement('div');
            header.className = 'flex items-center space-x-2 mb-1';
            header.innerHTML = `
                <strong class="font-bold ${isSenderAdmin ? 'text-red-700' : 'text-blue-600'}">${data.name}</strong>
                ${isSenderAdmin ? '<span class="text-xs bg-red-500 text-white px-2 py-0.5 rounded-full font-semibold">ADMIN</span>' : ''}
                <span class="text-xs text-gray-400 ml-auto" data-timestamp="${data.timestamp}">${formatTime(data.timestamp)}</span>
            `;
            
            // Message Text
            const text = document.createElement('p');
            text.className = 'break-words overflow-hidden';
            text.textContent = data.text;
            
            contentDiv.appendChild(header);
            contentDiv.appendChild(text);
            li.appendChild(contentDiv);

            // Admin Actions (Ban/Delete)
            if (currentUser && isAdmin) {
                const actionsDiv = document.createElement('div');
                // Use isBanMode to control initial visibility based on current state
                actionsDiv.className = `admin-actions flex space-x-2 ml-3 items-center flex-shrink-0 ${isBanMode ? 'opacity-100' : 'opacity-0'}`;
                
                // Ban Icon
                const banIcon = `<button class="admin-action-icon ban-icon text-red-500 hover:text-red-700 p-1 rounded-full bg-red-100 transition" data-uid="${data.uid}" data-name="${data.name}" data-message-id="${messageId}" title="Ban User">
                    <i data-lucide="user-x" class="w-4 h-4"></i>
                </button>`;
                
                // Delete Icon
                const deleteIcon = `<button class="admin-action-icon delete-icon text-gray-500 hover:text-gray-700 p-1 rounded-full bg-gray-100 transition" data-message-id="${messageId}" title="Delete Message">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>`;

                actionsDiv.innerHTML = banIcon + deleteIcon;
                li.appendChild(actionsDiv);
            }

            ui.messagesList.appendChild(li);
            ui.messagesList.scrollTop = ui.messagesList.scrollHeight;
            lucide.createIcons(); // Render icons
        });

        // Message REMOVAL
        onChildRemoved(messagesRef, (snapshot) => {
            const messageId = snapshot.key;
            const element = document.getElementById(`message-${messageId}`);
            if (element) {
                element.remove();
            }
        });

        // Update timestamps every minute
        setInterval(() => {
            document.querySelectorAll('[data-timestamp]').forEach(el => {
                const timestamp = parseInt(el.dataset.timestamp, 10);
                el.textContent = formatTime(timestamp);
            });
        }, 60000); 
        
        // --- 8. ACTIVE USERS (PRESENCE) LOGIC ---
        
        onValue(activeUsersRef, (snapshot) => {
            ui.activeUsersList.innerHTML = '';
            let userCount = 0;
            const users = snapshot.val();
            
            if (!users) {
                ui.activeUsersList.innerHTML = '<li class="text-gray-400">No users currently online.</li>';
                ui.activeUserCount.textContent = '0';
                return;
            }

            const uids = Object.keys(users);
            uids.forEach(uid => {
                const user = users[uid];
                const isSelf = currentUser && uid === currentUser.uid;
                const isUserAdmin = ADMIN_UIDS.includes(uid);
                
                if (user.name) {
                    const li = document.createElement('li');
                    li.className = 'flex items-center text-sm';
                    li.innerHTML = `
                        <i data-lucide="circle" class="w-2 h-2 mr-2 ${isSelf ? 'text-blue-500' : 'text-green-500'} fill-current"></i>
                        <span>${user.name}</span>
                        ${isUserAdmin ? '<span class="text-xs text-red-500 ml-1 font-semibold">(Admin)</span>' : ''}
                        ${isSelf ? '<span class="text-xs text-gray-400 ml-1">(You)</span>' : ''}
                    `;
                    ui.activeUsersList.appendChild(li);
                    userCount++;
                }
            });

            ui.activeUserCount.textContent = userCount.toString();
            lucide.createIcons();
        });
        
        // Initial icon creation for all static elements
        lucide.createIcons();

    </script>
</body>
</html>

